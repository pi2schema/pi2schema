allprojects {

    group 'com.github.pi2schema'
    version '0.2.0-SNAPSHOT'

    repositories {
        mavenCentral()

        //confluent jars are found on mavencentral but pom descriptors are missing causing gradle to fail
        maven { url 'https://packages.confluent.io/maven/' }
    }
}

subprojects {

    apply plugin: 'java'
    apply plugin: 'idea'
    apply plugin: 'jacoco'
    apply plugin: 'maven-publish'

    java {
        sourceCompatibility(JavaVersion.VERSION_1_8)
        targetCompatibility(JavaVersion.VERSION_1_8)
    }

    dependencies {

        compile 'ch.qos.logback:logback-classic:1.2.3'

        testImplementation 'org.junit.jupiter:junit-jupiter:5.7.0'
        testImplementation 'org.junit.jupiter:junit-jupiter-params:5.7.0'
        testImplementation 'org.assertj:assertj-core:3.17.2'
        testImplementation 'org.apache.commons:commons-lang3:3.11'
        testImplementation 'org.awaitility:awaitility:4.0.3'
        testImplementation 'org.mockito:mockito-core:3.5.10'
        testImplementation 'org.mockito:mockito-junit-jupiter:3.5.10'

    }

    test {
        useJUnitPlatform()
        testLogging {
            events "passed", "skipped", "failed"
        }
    }

    jacocoTestReport {

        // do not check test coverage for generated classes as protobuf : kafka kms
        afterEvaluate {
            classDirectories.setFrom(files(classDirectories.files.collect {
                fileTree(dir: it, exclude: ['pi2schema/kms/**', '**/*V1*.class'])
            }))
        }
        reports {
            xml.enabled true
            html.enabled true
        }
    }

	check.dependsOn jacocoTestReport

	publishing {
		repositories {
			maven {
				name = "GitHubPackages"
				url = uri("https://maven.pkg.github.com/pi2schema/pi2schema")
				credentials {
					username = System.getenv("GITHUB_ACTOR")
					password = System.getenv("GITHUB_TOKEN")
				}
			}
		}
		publications {
			gpr(MavenPublication) {
				from(components.java)
			}
		}
	}
}